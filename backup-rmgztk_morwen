#!/bin/sh

# $Id: backup-rmgztk_morwen,v 1.12 2002-11-10 10:43:55 turbo Exp $

DATE=`date +"%Y%m%d"`
BACKUPDIR=/var/.backups
HOSTNAME=`hostname`

BACKUPFILE1=$BACKUPDIR/System/$HOSTNAME-confs-$DATE.tar.bz2
BACKUPFILE2=$BACKUPDIR/OpenLDAP/$HOSTNAME-slapd-$DATE.ldif.bz2
BACKUPFILE3=$BACKUPDIR/KerberosV/$HOSTNAME-krb5-$DATE
BACKUPFILE5=/etc/dpkg/selections-$DATE.gz
BACKUPFILE7=$BACKUPDIR/Logs/$HOSTNAME-oldlogs-$DATE.tar.bz2

BACKUPFILES="$BACKUPFILE1 $BACKUPFILE2 $BACKUPFILE3.bz2 $BACKUPFILE7"

cd /

# Make sure the directoris exists.
for file in $BACKUPFILES; do
    dir=`dirname $file`
    [ ! -x $dir ] && mkdir -p $dir
done

# ----- L D A P -----
if [ -f /etc/init.d/slapd.backup ]; then
    /etc/init.d/slapd.backup stop > /dev/null 2>&1
    slapcat -n /var/lib/ldap.backup/id2entry.dbb | \
	egrep -v '^replace:' | \
	bzip2 > $BACKUPFILE2
    /etc/init.d/slapd.backup start > /dev/null 2>&1
fi

# ----- K E R B E R O S -----
kdb5_util dump $BACKUPFILE3
if [ -f $BACKUPFILE3.dump_ok ]; then
    bzip2 -9 $BACKUPFILE3
    rm $BACKUPFILE3.dump_ok
else
    echo "Could not dump krb5 db to $BACKUPFILE3!"
fi

# ----- I M P O R T A N T   C O N F I G F I L E S -----
dpkg --get-selections \* | sort | gzip -f9 > $BACKUPFILE5
tar cjpsf $BACKUPFILE1 `find %DIRS% \
    -type f | egrep -v '~$' | \
    sed -e 's@^/@@' -e 's@\.dpkg-dist@@' | \
    sort` > /dev/null 2>&1

# -----------------
# Logfiles...
cd /var/log && tar --remove-files -cjf $BACKUPFILE7 `find -name '*.gz'`

# Upload the backupfile to papadoc.
kinit -l 4m -k -t /etc/krb5.keytab.backup backup@BAYOUR.COM
for file in $BACKUPFILES; do
    file=`echo $file | sed "s@$BACKUPDIR/@@"`
    dir=`dirname $file` ; filename=`basename $file`

    if rcp -D 2106 -x $BACKUPDIR/$file backup@papadoc.bayour.com:/var/.backups/$dir/; then
	# Successfully uploaded file. Delete it, we don't have any free space!
	rm $BACKUPDIR/$file
    fi
done
kdestroy
